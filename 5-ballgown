library(ballgown)
library(RSkittleBrewer)
library(genefilter)
library(dplyr)
library(devtools)
library(org.Gg.eg.db)

#this folder contains the folder 'output', which in turn contains the folders for all samples
setwd("/Box/neu/rnaseq/Hisat index/NCBI-genome-based")

#read metadata in; this is a csv file; first column 'id' with sample names, second column 'group' with group names 
pheno_data = read.csv("phenodata.csv") #

#create ballgown object
ct12 = ballgown(dataDir = 'output', samplePattern = 'ct12', pData=pheno_data)

#Filter to remove low-abundance genes
ct12_filt = subset(ct12,"rowVars(texpr(ct12)) >1",genomesubset=TRUE)

#Identify genes that show statistically significant differences between groups, can be corrected for other factors
results_genes = stattest(ct12_filt, feature="gene", covariate="group", getFC=FALSE, meas="FPKM")

#create list with gene ids and gene names from the ballgown object and remove duplicates
geneIds=data.frame(ballgown::geneIDs(ct12_filt), eneNames=ballgown::geneNames(ct12_filt))
geneIds <- base::unique(geneIds)

#add gene names to the results
results_genes <- merge(results_genes, geneIds, by.x = 'id', by.y = 1)

#create the table with the chickengene information
uniKeys <- keys(org.Gg.eg.db, keytype="ENTREZID")
cols <- c("SYMBOL", "GENENAME")
annots <- AnnotationDbi::select(org.Gg.eg.db, keys = uniKeys, columns = cols, keytype = 'ENTREZID')

#add gene information to gene results
results_genes <- merge(results_genes, annots, by.x = 'eneNames', by.y="SYMBOL")
